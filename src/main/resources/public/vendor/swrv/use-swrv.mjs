import{reactive,watch,ref,toRefs,isRef,onMounted,onUnmounted,getCurrentInstance}from"../vue3/vue.esm-browser.js";import isDocumentVisible from"./lib/is-document-visible.mjs";import isOnline from"./lib/is-online.mjs";import SWRVCache from"./lib/cache.mjs";const DATA_CACHE=new SWRVCache,REF_CACHE=new SWRVCache,PROMISES_CACHE=new SWRVCache,defaultConfig={cache:DATA_CACHE,refreshInterval:0,ttl:0,serverTTL:1e3,dedupingInterval:2e3,revalidateOnFocus:!0,revalidateDebounce:0};function setRefCache(e,t,a){const n=REF_CACHE.get(e);if(n)n.data.push(t);else{const n=5e3;REF_CACHE.set(e,[t],a>0?a+n:a)}}const mutate=async(e,t,a=DATA_CACHE,n=defaultConfig.ttl)=>{let i,r,o;if(isPromise(t))try{i=await t}catch(e){r=e}else i=t;o=!1;const s={data:i,error:r,isValidating:false};void 0!==i&&a.set(e,s,n);const l=REF_CACHE.get(e);if(l&&l.data.length){let t=l.data.filter((t=>t.key===e));t.forEach(((e,a)=>{void 0!==s.data&&(e.data=s.data),s.error&&(e.error=s.error),e.isValidating=s.isValidating;a===t.length-1||delete t[a]})),t=t.filter(Boolean)}return s};export default function useSWRV(e,t,a){let n=!1,i=!1;const r=getCurrentInstance(),o=r.$isServer,s=Boolean(!o&&r.$vnode&&r.$vnode.elm&&r.$vnode.elm.dataset&&r.$vnode.elm.dataset.swrvKey);a={...defaultConfig,...a};const l=o?a.serverTTL:a.ttl,d="function"==typeof e?e:ref(e);let c=null;if(s){const e=window.__SWRV_STATE__||window.__NUXT__&&window.__NUXT__.swrv||[],t=+r.$vnode.elm.dataset.swrvKey;if(null!=t){const a=(e[t]||[])[isRef(d)?d.value:d()];a&&(c=reactive(a),i=!0)}}c||(c=reactive({data:void 0,error:null,isValidating:!0,key:null}));const u=async e=>{const i=d.value;if(!i)return;const r=a.cache.get(i);let o=r&&r.data;c.isValidating=!0,o&&(c.data=o.data,c.error=o.error);const s=e||t;if(!s||!isDocumentVisible())return void(c.isValidating=!1);if(r){if(!(Date.now()-r.createdAt>=a.dedupingInterval))return void(c.isValidating=!1)}const u=async()=>{const e=PROMISES_CACHE.get(i);if(e)await mutate(i,e.data,a.cache,l);else{const e=s(i);PROMISES_CACHE.set(i,e,a.dedupingInterval),await mutate(i,e,a.cache,l)}c.isValidating=!1,PROMISES_CACHE.delete(i)};o&&a.revalidateDebounce?await setTimeout((async()=>{n||await u()}),a.revalidateDebounce):await u()},v=async()=>u();let f=null;if(onMounted((()=>{const e=async()=>{!c.error&&isOnline()?await u():f&&clearTimeout(f),a.refreshInterval&&!n&&(f=setTimeout(e,a.refreshInterval))};a.refreshInterval&&(f=setTimeout(e,a.refreshInterval)),a.revalidateOnFocus&&(document.addEventListener("visibilitychange",v,!1),window.addEventListener("focus",v,!1))})),onUnmounted((()=>{n=!0,f&&clearTimeout(f),a.revalidateOnFocus&&(document.removeEventListener("visibilitychange",v,!1),window.removeEventListener("focus",v,!1))})),o){let e=[];r.$ssrContext&&(e=r.$ssrContext.swrv=r.$ssrContext.swrv||e);const t=e.length;(!r.$vnode||r.$node&&!r.$node.data)&&(r.$vnode={data:{attrs:{"data-swrv-key":t}}});(r.$vnode.data.attrs=r.$vnode.data.attrs||{})["data-swrv-key"]=t,r.$ssrContext&&r.$ssrContext.nuxt&&(r.$ssrContext.nuxt.swrv=e)}try{watch(d,(e=>{d.value=e,c.key=e,setRefCache(d.value,c,l),o||i||!d.value||u(),i=!1,f&&clearTimeout(f)}),{immediate:!0})}catch{}return{...toRefs(c),mutate:u}}function isPromise(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then}export{mutate};
