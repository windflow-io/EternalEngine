import{reactive,watch,ref,toRefs,isRef,onMounted,onUnmounted,getCurrentInstance}from"../vue3/vue.esm-browser.js";class SWRVCache{constructor(e=0){this.items=new Map,this.ttl=e}get(e){return this.items.get(e)}set(e,t,n){const a=n||this.ttl,i=Date.now(),s={data:t,createdAt:i,expiresAt:a?i+a:1/0};a&&setTimeout((()=>{Date.now()>=s.expiresAt&&this.delete(e)}),a),this.items.set(e,s)}delete(e){this.items.delete(e)}}function isDocumentVisible(){return"undefined"==typeof document||void 0===document.visibilityState||"hidden"!==document.visibilityState}function isOnline(){return void 0===navigator.onLine||navigator.onLine}const DATA_CACHE=new SWRVCache,REF_CACHE=new SWRVCache,PROMISES_CACHE=new SWRVCache,defaultConfig={cache:DATA_CACHE,refreshInterval:0,ttl:0,serverTTL:1e3,dedupingInterval:2e3,revalidateOnFocus:!0,revalidateDebounce:0};function setRefCache(e,t,n){const a=REF_CACHE.get(e);if(a)a.data.push(t);else{const a=5e3;REF_CACHE.set(e,[t],n>0?n+a:n)}}const mutate=async(e,t,n=DATA_CACHE,a=defaultConfig.ttl)=>{let i,s,r;if(isPromise(t))try{i=await t}catch(e){s=e}else i=t;r=!1;const o={data:i,error:s,isValidating:!1};void 0!==i&&n.set(e,o,a);const d=REF_CACHE.get(e);if(d&&d.data.length){let t=d.data.filter((t=>t.key===e));t.forEach(((e,n)=>{void 0!==o.data&&(e.data=o.data),o.error&&(e.error=o.error),e.isValidating=o.isValidating,n===t.length-1||delete t[n]})),t=t.filter(Boolean)}return o};function useSWRV(e,t,n){let a=!1,i=!1;const s=getCurrentInstance(),r=s.$isServer,o=Boolean(!r&&s.$vnode&&s.$vnode.elm&&s.$vnode.elm.dataset&&s.$vnode.elm.dataset.swrvKey);n={...defaultConfig,...n};const d=r?n.serverTTL:n.ttl,c="function"==typeof e?e:ref(e);let l=null;if(o){const e=window.__SWRV_STATE__||window.__NUXT__&&window.__NUXT__.swrv||[],t=+s.$vnode.elm.dataset.swrvKey;if(null!=t){const n=(e[t]||[])[isRef(c)?c.value:c()];n&&(l=reactive(n),i=!0)}}l||(l=reactive({data:void 0,error:null,isValidating:!0,key:null}));const u=async e=>{const i=c.value;if(!i)return;const s=n.cache.get(i);let r=s&&s.data;l.isValidating=!0,r&&(l.data=r.data,l.error=r.error);const o=e||t;if(!o||!isDocumentVisible())return void(l.isValidating=!1);if(s&&!(Date.now()-s.createdAt>=n.dedupingInterval))return void(l.isValidating=!1);const u=async()=>{const e=PROMISES_CACHE.get(i);if(e)await mutate(i,e.data,n.cache,d);else{const e=o(i);PROMISES_CACHE.set(i,e,n.dedupingInterval),await mutate(i,e,n.cache,d)}l.isValidating=!1,PROMISES_CACHE.delete(i)};r&&n.revalidateDebounce?await setTimeout((async()=>{a||await u()}),n.revalidateDebounce):await u()},v=async()=>u();let f=null;if(onMounted((()=>{const e=async()=>{!l.error&&isOnline()?await u():f&&clearTimeout(f),n.refreshInterval&&!a&&(f=setTimeout(e,n.refreshInterval))};n.refreshInterval&&(f=setTimeout(e,n.refreshInterval)),n.revalidateOnFocus&&(document.addEventListener("visibilitychange",v,!1),window.addEventListener("focus",v,!1))})),onUnmounted((()=>{a=!0,f&&clearTimeout(f),n.revalidateOnFocus&&(document.removeEventListener("visibilitychange",v,!1),window.removeEventListener("focus",v,!1))})),r){let e=[];s.$ssrContext&&(e=s.$ssrContext.swrv=s.$ssrContext.swrv||e);const t=e.length;(!s.$vnode||s.$node&&!s.$node.data)&&(s.$vnode={data:{attrs:{"data-swrv-key":t}}}),(s.$vnode.data.attrs=s.$vnode.data.attrs||{})["data-swrv-key"]=t,s.$ssrContext&&s.$ssrContext.nuxt&&(s.$ssrContext.nuxt.swrv=e)}try{watch(c,(e=>{c.value=e,l.key=e,setRefCache(c.value,l,d),r||i||!c.value||u(),i=!1,f&&clearTimeout(f)}),{immediate:!0})}catch{}return{...toRefs(l),mutate:u}}function isPromise(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then}export{mutate,SWRVCache};export default useSWRV;
